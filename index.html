<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Toxic Transition</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      :root {
        --bg: #090909;
        --text: #f2eee9;
        --text-muted: rgba(242, 238, 233, 0.9);
        --shadow: rgba(0, 0, 0, 0.72);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Avenir Next", "Helvetica Neue", Arial, sans-serif;
      }

      .intro {
        position: relative;
        height: 280vh;
      }

      .sticky-stage {
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: hidden;
        isolation: isolate;
        background: var(--bg);
      }

      .media-layer {
        position: absolute;
        inset: 0;
      }

      .media-layer video,
      .media-layer img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-layer {
        opacity: 1;
      }

      .photo-layer {
        opacity: 0;
      }

      .media-layer::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.25) 10%,
          rgba(0, 0, 0, 0.58) 65%,
          rgba(0, 0, 0, 0.72) 100%
        );
      }

      .text-layer {
        position: absolute;
        inset: 0;
        z-index: 2;
        display: grid;
        place-items: center;
        text-align: center;
        padding: 8vh 7vw;
      }

      .title {
        position: absolute;
        left: 50%;
        top: 50%;
        margin: 0;
        max-width: 12ch;
        font-size: clamp(2.25rem, 8vw, 6.4rem);
        letter-spacing: 0.03em;
        line-height: 0.95;
        text-transform: uppercase;
        text-shadow: 0 12px 36px var(--shadow);
        transform: translate(-50%, calc(-50% + var(--title-offset, 0px)));
      }

      .video-dek {
        position: absolute;
        left: 50%;
        top: 50%;
        margin: 0;
        max-width: min(920px, 90vw);
        font-size: clamp(1.05rem, 2.15vw, 1.9rem);
        line-height: 1.35;
        color: var(--text-muted);
        text-shadow: 0 8px 26px var(--shadow);
        opacity: 0;
        transform: translate(-50%, calc(-50% + var(--video-dek-offset, 0px)));
        text-wrap: pretty;
      }

      .photo-copy {
        position: absolute;
        left: 50%;
        top: 50%;
        margin: 0;
        max-width: min(1240px, 95vw);
        color: var(--text-muted);
        text-shadow: 0 8px 26px var(--shadow);
        opacity: 0;
        transform: translate(-50%, calc(-50% + var(--photo-copy-offset, 0px)));
        text-wrap: pretty;
      }

      .photo-copy p {
        margin: 0;
        font-size: clamp(1.05rem, 1.95vw, 1.62rem);
        line-height: 1.5;
      }

      .photo-copy p + p {
        margin-top: 1.6rem;
      }

      .after-intro {
        min-height: 35vh;
        padding: 12vh 8vw;
        background: #080808;
      }

      .after-intro p {
        margin: 0;
        max-width: 70ch;
        color: rgba(242, 238, 233, 0.72);
      }

      .map-scroll {
        position: relative;
        height: 260vh;
        background: #070707;
      }

      .map-sticky {
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: hidden;
        background: #050505;
      }

      .map-canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        border: 0;
        z-index: 1;
      }

      .map-overlay {
        position: absolute;
        inset: 0;
        z-index: 20;
        display: grid;
        place-items: center;
        padding: 8vh 7vw;
        pointer-events: none;
      }

      .map-copy {
        position: absolute;
        left: 50%;
        top: 50%;
        margin: 0;
        max-width: min(920px, 86vw);
        font-size: clamp(1.08rem, 2.1vw, 1.92rem);
        line-height: 1.45;
        text-align: center;
        color: rgba(242, 238, 233, 0.94);
        text-shadow: 0 10px 30px rgba(0, 0, 0, 0.95);
        opacity: 0;
        transform: translate(-50%, calc(-50% + var(--map-copy-offset, 0px)));
        text-wrap: pretty;
      }

      .map-copy-left {
        left: 18%;
        top: 66%;
        max-width: min(500px, 30vw);
        text-align: center;
      }

      .after-map {
        min-height: 35vh;
        padding: 12vh 8vw;
        background: #080808;
      }

      .after-map p {
        margin: 0;
        max-width: 70ch;
        color: rgba(242, 238, 233, 0.72);
      }

      @media (prefers-reduced-motion: reduce) {
        .video-layer,
        .photo-layer,
        .title,
        .video-dek,
        .photo-copy {
          transition: none !important;
        }
      }

      @media (max-width: 900px) {
        .map-copy-left {
          left: 50%;
          top: 68%;
          max-width: 88vw;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <section class="intro" id="intro">
      <div class="sticky-stage">
        <div class="media-layer video-layer" id="videoLayer">
          <video
            src="assets/drc_cobalt_front_vid.mov"
            autoplay
            muted
            loop
            playsinline
          ></video>
        </div>

        <div class="media-layer photo-layer" id="photoLayer">
          <img src="assets/Taillights.png" alt="Taillights in the DRC" />
        </div>

        <div class="text-layer">
          <h1 class="title" id="titleText">Toxic Transition</h1>
          <p class="video-dek" id="videoDek">
            A new investigation by the Environmental Investigation Agency US
            (EIA) and PremiCongo into cobalt mining in the Democratic Republic
            of the Congo (DRC) exposes the toxic underbelly of the world’s
            energy transition.
          </p>
          <div class="photo-copy" id="photoCopy">
            <p>
              The investigation: The last few years have seen dramatic growth
              in the production and sale of EVs, as well as in the lithium-ion
              batteries needed to power these vehicles. As a consequence,
              demand is surging for critical minerals like cobalt, which these
              batteries rely on.
            </p>
            <p>
              The investigation ties the rapid growth of the world’s largest
              cobalt producer and the booming production of electric vehicles
              (EVs) by some of the world’s largest car manufacturers - such as
              Volkswagen, Mercedes-Benz, BMW, and Stellantis - to what appears
              to be air pollution spanning multiple years, impacting dozens of
              families and workers.
            </p>
          </div>
        </div>
      </div>
    </section>

    <section class="map-scroll" id="mapScroll">
      <div class="map-sticky">
        <div id="mapCanvas" class="map-canvas" aria-label="Satellite map"></div>
        <div class="map-overlay">
          <p class="map-copy map-copy-left" id="mapCopyOne">
            Almost half the cobalt in the world is currently produced by a
            Chinese company called CMOC Group Ltd (CMOC; formerly China
            Molybdenum Co., Ltd.) through its mining operations in DRC.
          </p>
          <p class="map-copy" id="mapCopyTwo">
            This is where the group controls two of the world’s largest
            copper-cobalt mines: the Tenke Fungurume mine and the
            <span style="white-space: nowrap">Kisanfu mine.</span>
          </p>
        </div>
      </div>
    </section>

    <section class="after-map">
      <p>Continue with your next scrollytell section here.</p>
    </section>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const intro = document.getElementById("intro");
      const videoLayer = document.getElementById("videoLayer");
      const photoLayer = document.getElementById("photoLayer");
      const titleText = document.getElementById("titleText");
      const videoDek = document.getElementById("videoDek");
      const photoCopy = document.getElementById("photoCopy");
      const mapScroll = document.getElementById("mapScroll");
      const mapCopyOne = document.getElementById("mapCopyOne");
      const mapCopyTwo = document.getElementById("mapCopyTwo");

      const map = L.map("mapCanvas", {
        zoomControl: false,
        attributionControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        touchZoom: false,
        tap: false,
        zoomSnap: 0.01,
      }).setView([-1.5, 21.5], 5);

      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 18,
        }
      ).addTo(map);

      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 18,
        }
      ).addTo(map);

      const basinView = { lat: -1.5, lng: 21.5, zoom: 5.0 };
      const westCoastRef = [0.0, 9.0];
      const kisanfu = [-10.7870667, 25.9300361];
      const tenkeFungurume = [-10.6383278, 26.2913167];
      const mineBounds = L.latLngBounds([kisanfu, tenkeFungurume]);
      let mapStage = -1;
      let mineTargetsVisible = false;

      const kisanfuMarker = L.marker(kisanfu).bindTooltip("Kisanfu Mine", {
        permanent: false,
        direction: "top",
        offset: [0, -8],
      });

      const tenkeMarker = L.marker(tenkeFungurume).bindTooltip("Tenke Fungurume mine", {
        permanent: false,
        direction: "top",
        offset: [0, -8],
      });

      const mineMarkers = L.layerGroup([kisanfuMarker, tenkeMarker]);
      L.circleMarker(westCoastRef, {
        radius: 6,
        color: "#ffffff",
        weight: 2,
        fillColor: "#ffffff",
        fillOpacity: 0.2,
      }).addTo(map);

      function setMineTargets(visible) {
        if (mineTargetsVisible === visible) {
          return;
        }
        mineTargetsVisible = visible;
        if (visible) {
          mineMarkers.addTo(map);
          kisanfuMarker.openTooltip();
          tenkeMarker.openTooltip();
          return;
        }
        kisanfuMarker.closeTooltip();
        tenkeMarker.closeTooltip();
        map.removeLayer(mineMarkers);
      }

      function clamp(value, min, max) {
        return Math.min(max, Math.max(min, value));
      }

      function updateIntroProgress() {
        const rect = intro.getBoundingClientRect();
        const total = Math.max(1, rect.height - window.innerHeight);
        const scrolled = clamp(-rect.top, 0, total);
        const progress = scrolled / total;

        const mediaMix = clamp((progress - 0.48) / 0.28, 0, 1);
        const titleLift = clamp(progress / 0.22, 0, 1);
        const titleFade = clamp((progress - 0.58) / 0.2, 0, 1);
        const videoDekIn = clamp((progress - 0.07) / 0.12, 0, 1);
        const videoDekOut = clamp((progress - 0.52) / 0.16, 0, 1);
        const photoCopyFade = clamp((progress - 0.66) / 0.18, 0, 1);

        videoLayer.style.opacity = String(1 - mediaMix);
        photoLayer.style.opacity = String(mediaMix);

        titleText.style.opacity = String(1 - titleFade);
        titleText.style.setProperty("--title-offset", `${titleLift * -62}px`);

        const videoDekOpacity = videoDekIn * (1 - videoDekOut);
        videoDek.style.opacity = String(videoDekOpacity);
        videoDek.style.setProperty(
          "--video-dek-offset",
          `${60 + (1 - videoDekIn) * 16}px`
        );

        photoCopy.style.opacity = String(photoCopyFade);
        photoCopy.style.setProperty(
          "--photo-copy-offset",
          `${(1 - photoCopyFade) * 12}px`
        );
      }

      function goToMapStage(nextStage) {
        if (mapStage === nextStage) {
          return;
        }
        mapStage = nextStage;
        if (nextStage === 0) {
          setMineTargets(false);
          map.flyTo([basinView.lat, basinView.lng], basinView.zoom, {
            animate: true,
            duration: 1.6,
            easeLinearity: 0.2,
          });
          return;
        }
        map.flyToBounds(mineBounds, {
          paddingTopLeft: [70, 70],
          paddingBottomRight: [70, 70],
          animate: true,
          duration: 4.6,
          easeLinearity: 0.15,
          maxZoom: 12.2,
        });
      }

      function updateMapProgress() {
        const rect = mapScroll.getBoundingClientRect();
        const total = Math.max(1, rect.height - window.innerHeight);
        const scrolled = clamp(-rect.top, 0, total);
        const progress = scrolled / total;
        let activeStage = 0;
        const finalReveal = 0.85;

        if (progress < 0.28) {
          activeStage = 0;
          goToMapStage(0);
        } else {
          activeStage = 1;
          goToMapStage(1);
        }

        const copyOneIn = clamp((progress - 0.03) / 0.11, 0, 1);
        const copyOneOut = clamp((progress - 0.29) / 0.1, 0, 1);
        const copyOneOpacity = copyOneIn * (1 - copyOneOut);
        mapCopyOne.style.opacity = String(copyOneOpacity);
        mapCopyOne.style.transform =
          `translate(-50%, calc(-50% + ${(1 - copyOneIn) * 16}px))`;
        if (activeStage === 0) {
          const coastX = map.latLngToContainerPoint(westCoastRef).x;
          const desiredX = clamp(coastX * 0.5, 140, window.innerWidth * 0.42);
          mapCopyOne.style.left = `${desiredX}px`;
        }

        const copyTwoIn = clamp((progress - finalReveal) / 0.08, 0, 1);
        mapCopyTwo.style.opacity = String(copyTwoIn);
        mapCopyTwo.style.transform =
          `translate(-50%, calc(-50% + ${(1 - copyTwoIn) * 16}px))`;
        setMineTargets(activeStage === 1 && progress > finalReveal);
      }

      updateIntroProgress();
      updateMapProgress();
      window.addEventListener(
        "scroll",
        () => {
          updateIntroProgress();
          updateMapProgress();
        },
        { passive: true }
      );
      window.addEventListener("resize", () => {
        updateIntroProgress();
        map.invalidateSize();
        updateMapProgress();
      });
    </script>
  </body>
</html>
