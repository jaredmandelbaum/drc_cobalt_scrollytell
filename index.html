<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Toxic Transition</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      :root {
        --bg: #090909;
        --text: #f2eee9;
        --text-muted: rgba(242, 238, 233, 0.9);
        --shadow: rgba(0, 0, 0, 0.72);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Avenir Next", "Helvetica Neue", Arial, sans-serif;
      }

      .intro {
        position: relative;
        height: 280vh;
      }

      .sticky-stage {
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: hidden;
        isolation: isolate;
        background: var(--bg);
      }

      .media-layer {
        position: absolute;
        inset: 0;
      }

      .media-layer video,
      .media-layer img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-layer {
        opacity: 1;
      }

      .photo-layer {
        opacity: 0;
      }

      .media-layer::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.25) 10%,
          rgba(0, 0, 0, 0.58) 65%,
          rgba(0, 0, 0, 0.72) 100%
        );
      }

      .text-layer {
        position: absolute;
        inset: 0;
        z-index: 2;
        display: grid;
        place-items: center;
        text-align: center;
        padding: 8vh 7vw;
      }

      .intro-lockup {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, calc(-50% + var(--lockup-offset, 0px)));
        width: min(1100px, 92vw);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      .title {
        margin: 0;
        width: max-content;
        max-width: 100%;
        font-size: clamp(2.25rem, 8vw, 6.4rem);
        letter-spacing: 0.03em;
        line-height: 0.95;
        text-transform: uppercase;
        text-shadow: 0 12px 36px var(--shadow);
      }

      .video-dek {
        margin: 1.05rem 0 0;
        max-width: min(920px, 90vw);
        font-size: clamp(1.05rem, 2.15vw, 1.9rem);
        line-height: 1.35;
        color: var(--text-muted);
        text-shadow: 0 8px 26px var(--shadow);
        text-wrap: pretty;
      }

      .photo-copy {
        position: absolute;
        left: 50%;
        top: 50%;
        margin: 0;
        max-width: min(1240px, 95vw);
        color: rgba(246, 242, 236, 0.98);
        text-shadow: 0 8px 26px var(--shadow);
        opacity: 0;
        transform: translate(-50%, calc(-50% + var(--photo-copy-offset, 0px)));
        text-wrap: pretty;
        background: rgba(12, 12, 12, 0.54);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 18px;
        padding: clamp(1rem, 2.2vw, 2rem) clamp(1rem, 2.4vw, 2.2rem);
        backdrop-filter: blur(5px);
      }

      .photo-copy p {
        margin: 0;
        font-size: clamp(1.18rem, 2.28vw, 1.95rem);
        line-height: 1.56;
      }

      .photo-lead {
        display: block;
        margin-bottom: 0.72rem;
        font-size: clamp(2rem, 4vw, 3.15rem);
        font-weight: 800;
        letter-spacing: 0.01em;
        text-align: center;
      }

      .photo-copy p + p {
        margin-top: 2.5rem;
      }

      .after-intro {
        min-height: 35vh;
        padding: 12vh 8vw;
        background: #080808;
      }

      .after-intro p {
        margin: 0;
        max-width: 70ch;
        color: rgba(242, 238, 233, 0.72);
      }

      .map-scroll {
        position: relative;
        height: 420vh;
        background: #070707;
      }

      .map-sticky {
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: hidden;
        background: #050505;
      }

      .map-canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        border: 0;
        z-index: 1;
      }

      .map-overlay {
        position: absolute;
        inset: 0;
        z-index: 20;
        display: grid;
        place-items: center;
        padding: 8vh 7vw;
        pointer-events: none;
      }

      .map-copy {
        position: absolute;
        left: 50%;
        top: 50%;
        margin: 0;
        max-width: min(920px, 86vw);
        font-size: clamp(1.08rem, 2.1vw, 1.92rem);
        line-height: 1.45;
        text-align: center;
        color: rgba(242, 238, 233, 0.94);
        text-shadow: 0 10px 30px rgba(0, 0, 0, 0.95);
        opacity: 0;
        transform: translate(-50%, calc(-50% + var(--map-copy-offset, 0px)));
        text-wrap: pretty;
      }

      .map-copy-panel {
        background: rgba(10, 10, 10, 0.56);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 18px;
        padding: clamp(0.9rem, 2vw, 1.6rem) clamp(1rem, 2.2vw, 1.8rem);
        backdrop-filter: blur(5px);
      }

      .map-copy-left {
        left: 18%;
        top: 66%;
        max-width: min(500px, 30vw);
        text-align: center;
      }

      .map-copy-left-facility {
        left: 24%;
        top: 63%;
        max-width: min(600px, 34vw);
        text-align: left;
      }

      .map-copy-right-low {
        left: 64%;
        top: 74%;
        max-width: min(980px, 56vw);
        text-align: center;
      }

      .map-copy-strong {
        font-size: clamp(1.25rem, 2.5vw, 2.18rem);
        font-weight: 700;
        line-height: 1.35;
      }

      .after-map {
        min-height: 35vh;
        padding: 12vh 8vw;
        background: #080808;
      }

      .after-map p {
        margin: 0;
        max-width: 70ch;
        color: rgba(242, 238, 233, 0.72);
      }

      .bleed-scroll {
        position: relative;
        height: 360vh;
        background: #060606;
      }

      .bleed-sticky {
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: hidden;
        background: #060606;
      }

      .bleed-layout {
        position: absolute;
        inset: 0;
      }

      .bleed-text {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: min(55vw, 980px);
        z-index: 3;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10vh 5vw 10vh 8vw;
      }

      .bleed-text-inner {
        position: relative;
        width: 100%;
        max-width: 44ch;
        min-height: 48vh;
      }

      .bleed-copy {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        margin: 0;
        font-size: clamp(1.2rem, 2.2vw, 1.9rem);
        line-height: 1.52;
        color: rgba(245, 241, 235, 0.96);
        text-shadow: 0 10px 28px rgba(0, 0, 0, 0.82);
        opacity: 0;
      }

      .bleed-visuals {
        position: absolute;
        inset: 0;
        overflow: hidden;
      }

      .bleed-photo {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: 72% 50%;
        opacity: 0;
      }

      .bleed-video-wrap {
        position: absolute;
        inset: 0;
        opacity: 0;
      }

      .bleed-video-bg {
        position: absolute;
        inset: -8%;
        width: 116%;
        height: 116%;
        object-fit: cover;
        filter: blur(22px) brightness(0.72);
        transform: scale(1.12);
      }

      .bleed-video-bg-mask {
        position: absolute;
        inset: 0;
        background: rgba(5, 5, 5, 0.36);
      }

      .bleed-video-main {
        position: absolute;
        left: 50%;
        top: 50%;
        height: min(84vh, 980px);
        width: auto;
        transform: translate(-50%, -50%);
        border-radius: 14px;
        box-shadow: 0 24px 56px rgba(0, 0, 0, 0.62);
      }

      .bleed-left-shade {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: min(58vw, 1040px);
        background: linear-gradient(
          to right,
          rgba(5, 5, 5, 0.74) 0%,
          rgba(5, 5, 5, 0.58) 28%,
          rgba(5, 5, 5, 0.3) 60%,
          rgba(5, 5, 5, 0.1) 82%,
          rgba(5, 5, 5, 0) 100%
        );
        z-index: 2;
        pointer-events: none;
      }

      @media (prefers-reduced-motion: reduce) {
        .video-layer,
        .photo-layer,
        .title,
        .video-dek,
        .photo-copy {
          transition: none !important;
        }
      }

      @media (max-width: 900px) {
        .map-copy-left {
          left: 50%;
          top: 68%;
          max-width: 88vw;
          text-align: center;
        }

        .map-copy-left-facility,
        .map-copy-right-low {
          left: 50%;
          top: 66%;
          max-width: 90vw;
          text-align: center;
        }

        .bleed-layout {
          position: absolute;
          inset: 0;
        }

        .bleed-text {
          position: absolute;
          width: 100%;
          inset: auto 0 0 0;
          z-index: 3;
          padding: 4vh 7vw 5vh;
          background: linear-gradient(
            to top,
            rgba(6, 6, 6, 0.78) 0%,
            rgba(6, 6, 6, 0.32) 62%,
            rgba(6, 6, 6, 0) 100%
          );
        }

        .bleed-text p {
          max-width: 90vw;
          font-size: clamp(1.05rem, 4vw, 1.35rem);
          text-align: left;
        }

        .bleed-photo {
          object-fit: cover;
          object-position: center;
        }

        .bleed-left-shade {
          width: 100%;
          background: linear-gradient(
            to top,
            rgba(5, 5, 5, 0.66) 0%,
            rgba(5, 5, 5, 0.12) 52%,
            rgba(5, 5, 5, 0) 100%
          );
        }
      }
    </style>
  </head>
  <body>
    <section class="intro" id="intro">
      <div class="sticky-stage">
        <div class="media-layer video-layer" id="videoLayer">
          <video
            src="assets/drc_cobalt_front_vid.mov"
            autoplay
            muted
            loop
            playsinline
          ></video>
        </div>

        <div class="media-layer photo-layer" id="photoLayer">
          <img src="assets/Taillights.png" alt="Taillights in the DRC" />
        </div>

        <div class="text-layer">
          <div class="intro-lockup" id="introLockup">
            <h1 class="title" id="titleText">Toxic Transition</h1>
            <p class="video-dek" id="videoDek">
              A new investigation by the Environmental Investigation Agency US
              (EIA) and PremiCongo into cobalt mining in the Democratic Republic
              of the Congo (DRC) exposes the toxic underbelly of the world’s
              energy transition.
            </p>
          </div>
          <div class="photo-copy" id="photoCopy">
            <p>
              <span class="photo-lead">The Investigation</span>
              The last few years have seen dramatic growth in the production
              and sale of EVs, as well as in the lithium-ion batteries needed
              to power these vehicles. As a consequence, demand is surging for
              critical minerals like cobalt, which these batteries rely on.
            </p>
            <p>
              The investigation ties the rapid growth of the world’s largest
              cobalt producer and the booming production of electric vehicles
              (EVs) by some of the world’s largest car manufacturers - such as
              Volkswagen, Mercedes-Benz, BMW, and Stellantis - to what appears
              to be air pollution spanning multiple years, impacting dozens of
              families and workers.
            </p>
          </div>
        </div>
      </div>
    </section>

    <section class="map-scroll" id="mapScroll">
      <div class="map-sticky">
        <div id="mapCanvas" class="map-canvas" aria-label="Satellite map"></div>
        <div class="map-overlay">
          <p class="map-copy map-copy-left map-copy-panel" id="mapCopyOne">
            Almost half the cobalt in the world is currently produced by a
            Chinese company called CMOC Group Ltd (CMOC; formerly China
            Molybdenum Co., Ltd.) through its mining operations in DRC.
          </p>
          <p class="map-copy map-copy-panel" id="mapCopyTwo">
            This is where the group controls two of the world’s largest
            copper-cobalt mines: the Tenke Fungurume mine and the
            <span style="white-space: nowrap">Kisanfu mine.</span>
          </p>
          <p class="map-copy map-copy-left-facility map-copy-panel" id="mapCopyThree">
            In order to dominate the world’s cobalt hydroxide production, in
            2023 CMOC built one of the largest copper-cobalt processing
            complexes in Africa - about the size of 500 soccer fields - right
            next to Fungurume, a mining town in Lualaba province in southeast
            DRC.
          </p>
          <p class="map-copy map-copy-left-facility map-copy-panel" id="mapCopyFour">
            This colossal processing facility capable of processing 30,000 tons
            of copper-cobalt mixed ore every day is known as the “30k plant.”
          </p>
          <p class="map-copy map-copy-right-low map-copy-panel map-copy-strong" id="mapCopyFive">
            The problem is that thousands of people live within a few
            kilometers of the cobalt mine and its massive processing plant.
          </p>
        </div>
      </div>
    </section>

    <section class="bleed-scroll" id="bleedScroll">
      <div class="bleed-sticky">
        <div class="bleed-layout">
          <div class="bleed-text">
            <div class="bleed-text-inner">
              <p class="bleed-copy" id="bleedTextOne">
                In 2023 and 2024, communities and local civil society groups
                sounded the alarm about severe health issues, including severe
                nosebleeds, coughing up blood, and maternal issues, including
                stillbirth, that they attributed to the operations of CMOC’s new
                processing plant.
              </p>
              <p class="bleed-copy" id="bleedTextTwo">
                In its public statements, CMOC, via its subsidiary Tenke
                Fungurume Mining (TFM), denied the allegations of environmental
                pollution, its adverse impact on the population, and any
                connection to its activities.
              </p>
            </div>
          </div>
          <div class="bleed-visuals">
            <img
              class="bleed-photo"
              id="bleedPhoto1"
              src="assets/bleed1.jpg"
              alt="Community impact photo 1"
            />
            <img
              class="bleed-photo"
              id="bleedPhoto2"
              src="assets/bleed3.jpg"
              alt="Community impact photo 3"
            />
            <img
              class="bleed-photo"
              id="bleedPhoto3"
              src="assets/bleed2.jpg"
              alt="Community impact photo 2"
            />
            <div class="bleed-video-wrap" id="bleedVideoWrap">
              <video
                class="bleed-video-bg"
                src="assets/bleedvid.mp4"
                autoplay
                muted
                loop
                playsinline
              ></video>
              <div class="bleed-video-bg-mask"></div>
              <video
                class="bleed-video-main"
                src="assets/bleedvid.mp4"
                autoplay
                muted
                loop
                playsinline
              ></video>
            </div>
          </div>
          <div class="bleed-left-shade"></div>
        </div>
      </div>
    </section>

    <section class="after-map">
      <p>Continue with your next scrollytell section here.</p>
    </section>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const intro = document.getElementById("intro");
      const videoLayer = document.getElementById("videoLayer");
      const photoLayer = document.getElementById("photoLayer");
      const titleText = document.getElementById("titleText");
      const videoDek = document.getElementById("videoDek");
      const introLockup = document.getElementById("introLockup");
      const photoCopy = document.getElementById("photoCopy");
      const mapScroll = document.getElementById("mapScroll");
      const mapCopyOne = document.getElementById("mapCopyOne");
      const mapCopyTwo = document.getElementById("mapCopyTwo");
      const mapCopyThree = document.getElementById("mapCopyThree");
      const mapCopyFour = document.getElementById("mapCopyFour");
      const mapCopyFive = document.getElementById("mapCopyFive");
      const bleedScroll = document.getElementById("bleedScroll");
      const bleedPhoto1 = document.getElementById("bleedPhoto1");
      const bleedPhoto2 = document.getElementById("bleedPhoto2");
      const bleedPhoto3 = document.getElementById("bleedPhoto3");
      const bleedVideoWrap = document.getElementById("bleedVideoWrap");
      const bleedTextOne = document.getElementById("bleedTextOne");
      const bleedTextTwo = document.getElementById("bleedTextTwo");

      const map = L.map("mapCanvas", {
        zoomControl: false,
        attributionControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        touchZoom: false,
        tap: false,
        zoomSnap: 0.01,
      }).setView([-1.5, 21.5], 5);

      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 18,
        }
      ).addTo(map);

      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 18,
        }
      ).addTo(map);

      const basinView = { lat: -1.5, lng: 21.5, zoom: 5.0 };
      const westCoastRef = [0.0, 9.0];
      const kisanfu = [-10.7870667, 25.9300361];
      const tenkeFungurume = [-10.6383278, 26.2913167];
      const tenkeCenter = [-10.640100188663443, 26.282213719015243];
      const tenkeCloseBounds = L.latLngBounds(
        [-10.651300188663443, 26.263613719015244],
        [-10.628900188663443, 26.30081371901524]
      );
      const riskCenter = [-10.634007818200445, 26.306915449385475];
      const riskBounds = L.latLngBounds(
        [-10.643807818200445, 26.290415449385475],
        [-10.624207818200445, 26.323415449385475]
      );
      const mineBounds = L.latLngBounds([kisanfu, tenkeFungurume]);
      let mapStage = -1;
      let mineTargetsVisible = false;

      const kisanfuMarker = L.marker(kisanfu).bindTooltip("Kisanfu Mine", {
        permanent: false,
        direction: "top",
        offset: [0, -8],
      });

      const tenkeMarker = L.marker(tenkeFungurume).bindTooltip("Tenke Fungurume mine", {
        permanent: false,
        direction: "top",
        offset: [0, -8],
      });

      const mineMarkers = L.layerGroup([kisanfuMarker, tenkeMarker]);

      function setMineTargets(visible) {
        if (mineTargetsVisible === visible) {
          return;
        }
        mineTargetsVisible = visible;
        if (visible) {
          mineMarkers.addTo(map);
          kisanfuMarker.openTooltip();
          tenkeMarker.openTooltip();
          return;
        }
        kisanfuMarker.closeTooltip();
        tenkeMarker.closeTooltip();
        map.removeLayer(mineMarkers);
      }

      function clamp(value, min, max) {
        return Math.min(max, Math.max(min, value));
      }

      function setCopyVisible(copyEl, visible) {
        if (visible) {
          copyEl.style.opacity = "1";
          copyEl.style.transform = "translate(-50%, calc(-50% + 0px))";
          return;
        }
        copyEl.style.opacity = "0";
        copyEl.style.transform = "translate(-50%, calc(-50% + 16px))";
      }

      function updateMineOverviewRevealByZoom() {
        if (mapStage !== 1) {
          setCopyVisible(mapCopyTwo, false);
          setMineTargets(false);
          return;
        }
        const startZoom = basinView.zoom;
        const endZoom = map.getBoundsZoom(mineBounds, false, L.point(140, 140));
        const revealStart = startZoom + (endZoom - startZoom) * 0.85;
        const revealProgress = clamp((map.getZoom() - revealStart) / 0.28, 0, 1);
        mapCopyTwo.style.opacity = String(revealProgress);
        mapCopyTwo.style.transform = `translate(-50%, calc(-50% + ${(1 - revealProgress) * 16}px))`;
        setMineTargets(revealProgress > 0.02);
      }

      function updateIntroProgress() {
        const rect = intro.getBoundingClientRect();
        const total = Math.max(1, rect.height - window.innerHeight);
        const scrolled = clamp(-rect.top, 0, total);
        const progress = scrolled / total;

        const mediaMix = clamp((progress - 0.48) / 0.28, 0, 1);
        const titleLift = clamp(progress / 0.22, 0, 1);
        const titleFade = clamp((progress - 0.58) / 0.2, 0, 1);
        const photoCopyFade = clamp((progress - 0.66) / 0.18, 0, 1);

        videoLayer.style.opacity = String(1 - mediaMix);
        photoLayer.style.opacity = String(mediaMix);

        const lockupOpacity = String(1 - titleFade);
        introLockup.style.opacity = lockupOpacity;
        titleText.style.opacity = lockupOpacity;
        videoDek.style.opacity = lockupOpacity;
        introLockup.style.setProperty("--lockup-offset", `${titleLift * -62}px`);

        photoCopy.style.opacity = String(photoCopyFade);
        photoCopy.style.setProperty(
          "--photo-copy-offset",
          `${(1 - photoCopyFade) * 12}px`
        );
      }

      function goToMapStage(nextStage) {
        if (mapStage === nextStage) {
          return;
        }
        mapStage = nextStage;
        if (nextStage === 0) {
          setMineTargets(false);
          setCopyVisible(mapCopyTwo, false);
          setCopyVisible(mapCopyThree, false);
          setCopyVisible(mapCopyFour, false);
          setCopyVisible(mapCopyFive, false);
          map.flyTo([basinView.lat, basinView.lng], basinView.zoom, {
            animate: true,
            duration: 1.6,
            easeLinearity: 0.2,
          });
          return;
        }
        if (nextStage === 1) {
          setCopyVisible(mapCopyTwo, false);
          setMineTargets(false);
          map.flyToBounds(mineBounds, {
            paddingTopLeft: [70, 70],
            paddingBottomRight: [70, 70],
            animate: true,
            duration: 3.8,
            easeLinearity: 0.15,
            maxZoom: 12.2,
          });
          return;
        }
        if (nextStage === 2) {
          setMineTargets(false);
          setCopyVisible(mapCopyTwo, false);
          map.flyToBounds(tenkeCloseBounds, {
            paddingTopLeft: [8, 8],
            paddingBottomRight: [8, 8],
            animate: true,
            duration: 2.6,
            easeLinearity: 0.15,
            maxZoom: 16.5,
          });
          return;
        }
        if (nextStage === 3) {
          setMineTargets(false);
          setCopyVisible(mapCopyTwo, false);
          // Keep the same close-up camera as stage 2; only text changes.
          return;
        }
        setMineTargets(false);
        setCopyVisible(mapCopyTwo, false);
        map.flyToBounds(riskBounds, {
          animate: true,
          duration: 2.2,
          easeLinearity: 0.15,
          maxZoom: 15.8,
        });
      }

      function updateMapProgress() {
        const rect = mapScroll.getBoundingClientRect();
        const total = Math.max(1, rect.height - window.innerHeight);
        const scrolled = clamp(-rect.top, 0, total);
        const progress = scrolled / total;
        let activeStage = 0;
        if (progress < 0.22) {
          activeStage = 0;
          goToMapStage(0);
        } else if (progress < 0.46) {
          activeStage = 1;
          goToMapStage(1);
        } else if (progress < 0.66) {
          activeStage = 2;
          goToMapStage(2);
        } else if (progress < 0.82) {
          activeStage = 3;
          goToMapStage(3);
        } else {
          activeStage = 4;
          goToMapStage(4);
        }

        const copyOneIn = clamp((progress - 0.03) / 0.11, 0, 1);
        const copyOneOut = clamp((progress - 0.20) / 0.06, 0, 1);
        const copyOneOpacity = copyOneIn * (1 - copyOneOut);
        mapCopyOne.style.opacity = String(copyOneOpacity);
        mapCopyOne.style.transform =
          `translate(-50%, calc(-50% + ${(1 - copyOneIn) * 16}px))`;
        if (activeStage === 0) {
          const coastX = map.latLngToContainerPoint(westCoastRef).x;
          const desiredX = clamp(coastX * 0.5, 140, window.innerWidth * 0.42);
          mapCopyOne.style.left = `${desiredX}px`;
        }

        updateMineOverviewRevealByZoom();
        setCopyVisible(mapCopyThree, activeStage === 2);
        setCopyVisible(mapCopyFour, activeStage === 3);
        setCopyVisible(mapCopyFive, activeStage === 4);
      }

      function updateBleedProgress() {
        const rect = bleedScroll.getBoundingClientRect();
        const total = Math.max(1, rect.height - window.innerHeight);
        const scrolled = clamp(-rect.top, 0, total);
        const progress = scrolled / total;

        const p1In = clamp((progress - 0.05) / 0.14, 0, 1);
        const p1Out = clamp((progress - 0.30) / 0.16, 0, 1);
        const p1 = p1In * (1 - p1Out);
        const p2In = clamp((progress - 0.26) / 0.16, 0, 1);
        const p2Out = clamp((progress - 0.56) / 0.18, 0, 1);
        const p2 = p2In * (1 - p2Out);
        const p3In = clamp((progress - 0.52) / 0.2, 0, 1);
        const p3Out = clamp((progress - 0.82) / 0.12, 0, 1);
        const p3 = p3In * (1 - p3Out);
        const videoIn = clamp((progress - 0.82) / 0.14, 0, 1);
        const textOneIn = clamp((progress - 0.06) / 0.13, 0, 1);
        const textOneOut = clamp((progress - 0.40) / 0.12, 0, 1);
        const textOne = textOneIn * (1 - textOneOut) * (1 - videoIn);
        const textTwoIn = clamp((progress - 0.52) / 0.14, 0, 1);
        const textTwoOut = clamp((progress - 0.78) / 0.12, 0, 1);
        const textTwo = textTwoIn * (1 - textTwoOut) * (1 - videoIn);

        bleedPhoto1.style.opacity = String(p1);
        bleedPhoto2.style.opacity = String(p2);
        bleedPhoto3.style.opacity = String(p3);
        bleedVideoWrap.style.opacity = String(videoIn);
        bleedTextOne.style.opacity = String(textOne);
        bleedTextTwo.style.opacity = String(textTwo);
      }

      updateIntroProgress();
      updateMapProgress();
      updateBleedProgress();
      window.addEventListener(
        "scroll",
        () => {
          updateIntroProgress();
          updateMapProgress();
          updateBleedProgress();
        },
        { passive: true }
      );
      window.addEventListener("resize", () => {
        updateIntroProgress();
        map.invalidateSize();
        updateMapProgress();
        updateBleedProgress();
      });
      map.on("zoom move", updateMineOverviewRevealByZoom);
    </script>
  </body>
</html>
